#!/usr/bin/env bash

# â”â”“ â”â”â”“â”â”â”“   â”â”â”“â•» â•»â”â”â”“
# â”£â”»â”“â”£â”â”«â”£â”³â”›â•ºâ”â•¸â”—â”â”“â”—â”³â”›â”—â”â”“
# â”—â”â”›â•¹ â•¹â•¹â”—â•¸   â”—â”â”› â•¹ â”—â”â”›
# simple systray for dwmblocks

WARN="ğŸ”´"

function is_online {
    if ! ping -4 -q -c 1 "www.linux.org" >/dev/null; then
        return 1
    fi

    return 0
}

function get_interface {
    if ! is_online; then
        printf "%s" "ï„§"
        return
    fi

    local status count active
    local ether="eno1"
    local wlan="wlp2s0"

    declare -A interfaces
    interfaces["$ether"]="ó°ˆ€" # "ó°¡" "ï›¿" "î½„"
    interfaces["$wlan"]="ï‡«"  # "ï’„"  "î˜™"  "ï‚" "ï‡«" "ï€’" "ï‚¬"

    local exclude="loopback"
    status=$(nmcli device status | grep "$ether\|$wlan")
    count=$(echo "$status" | grep -c "connected")

    if [[ "$count" -lt 1 ]]; then
        printf "%s" "ï„§"
    elif [[ "$count" -eq 1 ]]; then
        active=$(echo "$status" | grep "connected" | grep -v "$exclude" | awk '{print $1}')
        printf "%s" "${interfaces[$active]}"
    else
        printf "${WARN}%s" "${interfaces[*]}"
    fi
}

function get_icons {
    declare -a icons=()
    icons+=(ï„° ï„± ï„œ ï„¾ î™² ï”ª ï‡¦ ï„§ ï‡« ï€’ ïŠ“ ïŠ” ïŠ™ ï‹ ï‹’ ï‘¶ ï‡¶ ï’¼)
    icons+=(îš“ î© î™ î• î“ îš® îŸ… î˜« ï€ ï‹ î˜‚ ï¶ ï¬ ïª ï‚¬ ï‚­ ï‚® ïƒ¢)
    icons+=(ï›¿ ó°ˆ€ î½„ ï± î­¹ î­º î­» î¯† ïŒ® ï“‡ ï“‰ ï“… ïˆŸ)
    icons+=(ï€½ î¶­ î¼« î¼ª î½¡ î¾ î¾— î¿… î¸ îˆº ï‹« ï‹ª ï‹¹)
    icons+=(î™„ î˜¸ î©° î°œ î´ƒ î¸• î¹˜ î¹™ î»¨ î¼‰ î¾ƒ ï€“ ï€” ï€¦ ï­ î´¯ ïƒ¤ îº² îº³ ï…¦)
    icons+=(î¹¸ î¹· î¼ î¼œ î¼› î¼š î¼– î¼ î¼­ î¼¬ î¼« î¼ª î¼© ï‡¬ ï‡¶ ï‡·)
    icons+=(ï‹“ ï‹± ï‹¹ ï‹² ï¬ ï‘¶ ï‘¸ ï’š ï’› ïˆ… ïˆ„ ï– ï±)
    icons+=(î¶ˆ î¶‰ î¶‡ î¶‚ î´µ î´™ î¹˜ î¹™ î»­ ïŠ» ïŠ½ ïŠ¹ ï‹‚ ïŠ îº» î˜± ï‡  ï‡¡)
    icons+=(ï€½ ï‚Š ï‚— ï‘º ï‡€ ï‘² ï‹“ ï‹” îª© î©¥)
    icons+=(î¯« î¯¬ î¯­ î¯® î¯¯ î¯° î¯± î¯² î¯³ î¯´ î¯µ î¯¶ î¯· î°€ î° î°‚)
}

function is_bluetooth_on {
    local active="ïŠ“"
    local inactive="ïŠ”"
    if bluetoothctl show | grep -q "Powered: yes"; then
        info=$(bluetoothctl info)
        if [[ $info == *"Missing"* ]]; then
            printf "%s" "$inactive"
            return
        fi

        printf "%s" "$active"
        return
    fi
}

function is_microphone_on {
    local enable="ï„°"
    local disable="ï„±"
    local card=2
    local mic="Mic"

    amixer -c "$card" get "$mic" &>/dev/null
    local retcode=$?
    if [[ "$retcode" -ne 0 ]]; then
        return
    fi

    local mic_status
    mic_status=$(amixer -c "$card" get "$mic" | grep "Front Left:" | awk '{print $7}')

    if [[ "$mic_status" != "[on]" ]]; then
        echo "$disable"
        return
    fi

    echo "$enable"
}

function is_cpu_perform {
    local icon="îº²" # "î´¯ îº² îº³"
    local target="performance"
    governor=$(cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor)
    if [[ "$governor" == "$target" ]]; then
        return
    fi
    echo "$icon"
}

function is_notifications_on {
    if ! pgrep -x dunst >/dev/null; then
        echo "ï‡¶"
        return
    fi

    paused=$(dunstctl is-paused)
    if [[ ! $paused == "false" ]]; then
        echo "ï‡¶"
        return
    fi
}

function is_capslock_on {
    local capslock_on
    capslock_on=$(xset -q | grep Caps | awk '{print $4}')

    if [[ ! "$capslock_on" == "off" ]]; then
        echo "${WARN}ï€±"
    fi
}

function is_mpd_playing {
    if mpc status | grep playing >/dev/null; then
        echo "ï‹"
    fi
}

function is_redshift_enable {
    local enable="ï®"
    local enable=""
    local disable="ïŠ¨" # "ï°"
    # Get the gamma values from xrandr. When redshift isn't on, all values are 1.0.
    GAMMAX=$(xrandr --verbose | grep 'Gamma' | awk -F ':' '{print $2}' | tr -d ' ')
    GAMMAY=$(xrandr --verbose | grep 'Gamma' | awk -F ':' '{print $3}' | tr -d ' ')
    GAMMAZ=$(xrandr --verbose | grep 'Gamma' | awk -F ':' '{print $4}' | tr -d ' ')
    # Check for at least one value not being 1.0. X appears to stay as 1.0, but Y and Z change.
    if [[ "$GAMMAX" != 1.0 ]] || [[ "$GAMMAY" != 1.0 ]] || [[ "$GAMMAZ" != 1.0 ]]; then
        echo "${enable}"
    else
        echo "${disable}"
    fi
}

function is_running {
    local cmd="$1"
    local enable="$2"
    local disable="$3"
    declare -a args

    if [[ ${#cmd} -gt 15 ]]; then
        args=("-f" "$cmd")
    else
        args=("-x" "$cmd")
    fi

    if ! pgrep "${args[@]}" >/dev/null; then
        printf "%s" "$disable"
    else
        printf "%s" "$enable"
    fi
}

function is_running_new {
    local cmd="$1"
    local enable="$2"
    local disable="$3"

    # Usar pgrep -f y luego filtrar solo el PID del proceso principal
    pid=$(pgrep -f -o "$cmd")

    if [[ -z "$pid" ]]; then
        printf "%s" "$disable"
    else
        # Si el PID es vÃ¡lido, verificamos que no sea un subproceso
        # Puedes ajustar esta parte para que valid mÃ¡s especÃ­ficamente segÃºn lo que necesitas
        if ps -p "$pid" -o comm= | grep -E "^$cmd" >/dev/null; then
            printf "%s" "$enable"
        else
            printf "%s" "$disable"
        fi
    fi
}

function main {
    declare -A programs
    programs["transmission-daemon"]="ï¶"
    programs["timer"]="ï‹²"
    programs["ollama"]="ï†ˆ"
    programs["bitwarden"]="ï„²"
    programs["jellyfin"]="ó°¿"
    programs["galculator"]="ï‡¬"
    programs["newsboat"]="ï‡ª"       # "ó°•" "ï…ƒ" # "î˜™" "ï‚" "ó±€„"
    programs["mpv"]="îšŸ"            # îšŸ # ï®
    programs["signal-desktop"]="ï‰º" # "î½½"
    programs["dragon"]="ï‡ "
    programs["telegram"]="îˆ—"
    programs["share-files"]="ï‡ "
    programs["tor"]="ï±"
    # programs["goairdrop"]="ï”"
    # programs["obs"]="ï€½"
    # programs["tidal-hifi"]="ï€"
    # programs["ytlocal"]="ï…ª"
    # programs["xbps-install"]="ïƒ¢"

    mapfile -t icons < <(get_interface)
    icons+=("$(is_microphone_on)")
    icons+=("$(is_bluetooth_on)")
    icons+=("$(is_cpu_perform)")

    for prog in "${!programs[@]}"; do
        icon=${programs[$prog]}
        icons+=("$(is_running "$prog" "$icon")")
    done

    # maybe implement option to display fallback icon if proc not running
    icons+=("$(is_running "xautolock" "" "ï‹¼")")
    icons+=("$(is_running "pyytx" "" "ï‚¸")")
    # icons+=("$(is_running "pytlocal" "" "ï‚¸")")
    icons+=("$(is_running "goairdrop" "" "îº‡")")
    icons+=("$(is_running "udiskie" "" "î¼ˆ")")

    icons+=("$(is_notifications_on)")
    icons+=("$(is_redshift_enable)")
    icons+=("$(is_capslock_on)")
    # icons+=("$(is_mpd_playing)")

    printf "%s" "${SEP1:-}"
    for icon in "${icons[@]}"; do
        [[ -n "$icon" ]] && printf "%s  " "$icon"
    done
    printf "%s\n" "${SEP2:-}"
}

main
